<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Set Dev Token</title>
    <style>
      body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; display:flex;align-items:center;justify-content:center;height:100vh;background:#0f172a;color:#e6eef8;margin:0 }
      .card{background:#071133;padding:24px;border-radius:8px;max-width:680px;width:100%;box-shadow:0 6px 24px rgba(2,6,23,.6)}
      pre{white-space:pre-wrap;word-break:break-word}
      button{margin-top:12px}
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Dev: imposta token di accesso</h1>
      <p>Questa pagina effettua il login con l'utente di test e salva il token in <code>localStorage</code>, poi reindirizza all'app.</p>
      <div id="status">Avvio...</div>
      <pre id="debug"></pre>
      <button id="retry" style="display:none">Riprova</button>
    </div>

    <script>
      async function setDevToken() {
        const status = document.getElementById('status');
        const debug = document.getElementById('debug');
        const retry = document.getElementById('retry');
        retry.style.display = 'none';
        status.textContent = 'Chiamata API per ottenere token...';
        debug.textContent = '';

        try {
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: 'test@example.com', password: 'password123' })
          });

          if (!res.ok) {
            const err = await res.json().catch(() => null);
            status.textContent = 'Login fallito: ' + (err?.msg || res.status + ' ' + res.statusText);
            debug.textContent = JSON.stringify(err, null, 2) || '';
            retry.style.display = '';
            return;
          }

          const data = await res.json();
          const token = data.token || data?.token;
          if (!token) {
            status.textContent = 'Nessun token ricevuto dal server';
            debug.textContent = JSON.stringify(data, null, 2);
            retry.style.display = '';
            return;
          }

          // Salva il token e reindirizza
          localStorage.setItem('token', token);
          status.textContent = 'Token impostato correttamente. Reindirizzo all\'app...';
          debug.textContent = token.substring(0, 80) + (token.length > 80 ? '...' : '');

          // Small delay so user sees status
          setTimeout(() => {
            window.location.href = '/';
          }, 700);
        } catch (err) {
          status.textContent = 'Errore durante la richiesta: ' + (err.message || err);
          debug.textContent = String(err);
          retry.style.display = '';
        }
      }

      document.getElementById('retry').addEventListener('click', setDevToken);
      // Run immediately
      setDevToken();
    </script>
  </body>
</html>
